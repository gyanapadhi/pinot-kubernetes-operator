# Pinot Operator Testing Makefile
# This Makefile provides convenient commands for testing the Pinot operator

.PHONY: help start stop status test clean data quickstart

# Default target
help:
	@echo "ğŸ§ª Pinot Operator Testing Commands"
	@echo "=================================="
	@echo ""
	@echo "ğŸš€ Cluster Management:"
	@echo "  start        - Start full Pinot cluster"
	@echo "  quickstart   - Start Pinot in quickstart mode (all-in-one)"
	@echo "  stop         - Stop Pinot cluster"
	@echo "  stop-clean   - Stop cluster and remove volumes"
	@echo "  status       - Check cluster status"
	@echo ""
	@echo "ğŸ§ª Testing:"
	@echo "  test         - Run complete test suite"
	@echo "  test-crds    - Test CRD deployment"
	@echo "  test-operator - Test operator deployment"
	@echo "  test-resources - Test custom resources"
	@echo ""
	@echo "ğŸ“Š Data and Monitoring:"
	@echo "  data         - Generate test data"
	@echo "  logs         - View service logs"
	@echo "  logs-follow  - Follow service logs"
	@echo ""
	@echo "ğŸ§¹ Maintenance:"
	@echo "  clean        - Clean up all test resources"
	@echo "  reset        - Stop cluster, clean, and restart"

# Start full Pinot cluster
start:
	@echo "ğŸš€ Starting full Pinot cluster..."
	@./scripts/start-pinot.sh

# Start Pinot in quickstart mode
quickstart:
	@echo "ğŸ“¦ Starting Pinot in quickstart mode..."
	@./scripts/start-pinot.sh quickstart

# Stop Pinot cluster
stop:
	@echo "ğŸ›‘ Stopping Pinot cluster..."
	@./scripts/stop-pinot.sh

# Stop cluster and remove volumes
stop-clean:
	@echo "ğŸ§¹ Stopping cluster and removing volumes..."
	@./scripts/stop-pinot.sh clean

# Check cluster status
status:
	@echo "ğŸ“Š Checking cluster status..."
	@./scripts/check-status.sh

# Run complete test suite
test:
	@echo "ğŸ§ª Running complete test suite..."
	@./scripts/run-tests.sh

# Test CRD deployment
test-crds:
	@echo "ğŸ“‹ Testing CRD deployment..."
	@if command -v kubectl > /dev/null 2>&1; then \
		kubectl apply -f ../k8s/crds.yaml; \
		echo "âœ… CRDs deployed successfully"; \
	else \
		echo "âŒ kubectl not available, skipping CRD test"; \
	fi

# Test operator deployment
test-operator:
	@echo "ğŸš€ Testing operator deployment..."
	@if command -v kubectl > /dev/null 2>&1; then \
		kubectl apply -f ../k8s/operator.yaml; \
		echo "âœ… Operator deployed successfully"; \
	else \
		echo "âŒ kubectl not available, skipping operator test"; \
	fi

# Test custom resources
test-resources:
	@echo "ğŸ“ Testing custom resources..."
	@if command -v kubectl > /dev/null 2>&1; then \
		kubectl apply -f configs/test-pinot-cluster.yaml; \
		kubectl apply -f configs/test-schema.yaml; \
		kubectl apply -f configs/test-table.yaml; \
		kubectl apply -f configs/test-tenant.yaml; \
		echo "âœ… Custom resources deployed successfully"; \
	else \
		echo "âŒ kubectl not available, skipping resource tests"; \
	fi

# Generate test data
data:
	@echo "ğŸ“Š Generating test data..."
	@./scripts/generate-test-data.sh

# View service logs
logs:
	@echo "ğŸ“ Viewing service logs..."
	@docker-compose logs

# Follow service logs
logs-follow:
	@echo "ğŸ“ Following service logs..."
	@docker-compose logs -f

# Clean up all test resources
clean:
	@echo "ğŸ§¹ Cleaning up test resources..."
	@if command -v kubectl > /dev/null 2>&1; then \
		kubectl delete -f configs/test-tenant.yaml 2>/dev/null || true; \
		kubectl delete -f configs/test-table.yaml 2>/dev/null || true; \
		kubectl delete -f configs/test-schema.yaml 2>/dev/null || true; \
		kubectl delete -f configs/test-pinot-cluster.yaml 2>/dev/null || true; \
		echo "âœ… Test resources cleaned up"; \
	else \
		echo "âš ï¸  kubectl not available, skipping resource cleanup"; \
	fi
	@docker-compose down 2>/dev/null || true
	@echo "âœ… Docker containers stopped"

# Reset everything
reset: stop-clean clean start
	@echo "ğŸ”„ Reset complete!"

# Show cluster info
info:
	@echo "ğŸ“Š Cluster Information:"
	@echo "========================"
	@docker-compose ps
	@echo ""
	@echo "ğŸŒ Access URLs:"
	@echo "  - Controller: http://localhost:9050"
	@echo "  - Broker: http://localhost:8099"
	@echo "  - Server: http://localhost:8098"
	@echo "  - Minion: http://localhost:8097"
	@echo "  - Zookeeper: localhost:2182"

# Health check
health:
	@echo "ğŸ” Health Check:"
	@echo "================"
	@curl -s -f http://localhost:9050/health > /dev/null && echo "âœ… Controller: Healthy" || echo "âŒ Controller: Unhealthy"
	@curl -s -f http://localhost:8099/health > /dev/null && echo "âœ… Broker: Healthy" || echo "âŒ Broker: Unhealthy"
	@curl -s -f http://localhost:8098/health > /dev/null && echo "âœ… Server: Healthy" || echo "âŒ Server: Unhealthy"
	@curl -s -f http://localhost:8097/health > /dev/null && echo "âœ… Minion: Healthy" || echo "âŒ Minion: Unhealthy"
